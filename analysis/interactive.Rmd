---
title: "Interactive data exploration"
author: "James Ashmore"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Setup

Load CRAN packages:

```{r}
library(rsconnect)
```

Include Bioconductor package repositories:

```{r}
options(repos = BiocManager::repositories())
```

Automatically answer yes to any user prompt:

```{r}
options(needs.promptUser = FALSE)
```

Create shiny directory for interactive data exploration:

```{r}
dir.create("shiny", showWarnings = FALSE, mode = "0755")
```

## Applications {.tabset}

### Annotated data

Delete existing iSEE directory for annotated data:

```{r}
unlink("shiny/annotated", recursive = TRUE)
```

Create iSEE directory for annotated data:

```{r}
dir.create("shiny/annotated", showWarnings = FALSE, mode = "0755")
```

Copy annotated data to iSEE directory:

```{r}
file.copy("output/09-cell-annotation.rds", "shiny/annotated/data.rds", overwrite = TRUE)
```

Write application code to file within iSEE directory:

```{cat, engine.opts = list(file = "shiny/annotated/app.R"), class.source = "r"}
library(SingleCellExperiment)

sce <- readRDS("data.rds")

rownames(sce) <- scuttle::uniquifyFeatureNames(rowData(sce)$gene_id, rowData(sce)$gene_name)

library(iSEE)

celltype_colours <- function(x) {
    return(
        c(
            "Epiblast" = "#635547",
            "Primitive Streak" = "#DABE99",
            "Caudal epiblast" = "#9e6762",
            "PGC" = "#FACB12",
            "Anterior Primitive Streak" = "#c19f70",
            "Notochord" = "#0F4A9C",
            "Def. endoderm" = "#F397C0",
            "Gut" = "#EF5A9D",
            "Nascent mesoderm" = "#C594BF",
            "Mixed mesoderm" = "#DFCDE4",
            "Intermediate mesoderm" = "#139992",
            "Caudal Mesoderm" = "#3F84AA",
            "Paraxial mesoderm" = "#8DB5CE",
            "Somitic mesoderm" = "#005579",
            "Pharyngeal mesoderm" = "#C9EBFB",
            "Cardiomyocytes" = "#B51D8D",
            "Allantois" = "#532C8A",
            "ExE mesoderm" = "#8870ad",
            "Mesenchyme" = "#cc7818",
            "Haematoendothelial progenitors" = "#FBBE92",
            "Endothelium" = "#ff891c",
            "Blood progenitors 1" = "#f9decf",
            "Blood progenitors 2" = "#c9a997",
            "Erythroid1" = "#C72228",
            "Erythroid2" = "#f79083",
            "Erythroid3" = "#EF4E22",
            "NMP" = "#8EC792",
            "Rostral neurectoderm" = "#65A83E",
            "Caudal neurectoderm" = "#354E23",
            "Neural crest" = "#C3C388",
            "Forebrain/Midbrain/Hindbrain" = "#647a4f",
            "Spinal cord" = "#CDE088",
            "Surface ectoderm" = "#f7f79e",
            "Visceral endoderm" = "#F6BFCB",
            "ExE endoderm" = "#7F6874",
            "ExE ectoderm" = "#989898",
            "Parietal endoderm" = "#1A1A1A"
        )
    )
)

stage_colours <- function(x) {
	return(
		c(
			"E6.5" = "#D53E4F",
			"E6.75" = "#F46D43",
			"E7.0" = "#FDAE61",
			"E7.25" = "#FEE08B",
			"E7.5" = "#FFFFBF",
			"E7.75" = "#E6F598",
			"E8.0" = "#ABDDA4",
			"E8.25" = "#66C2A5",
			"E8.5" = "#3288BD",
			"mixed_gastrulation" = "#A9A9A9"
		)
	)
}

theiler_colours <- function(x) {
	return(
		c(
			"TS9" = "#D7191C",
			"TS10" = "#FDAE61",
			"TS11" = "#ABDDA4",
			"TS12" = "#2B83BA",
			"TS9-10" = "#A9A9A9"
		)
	)
}

ecm <- ExperimentColorMap(colData = list(celltype = celltype_colours, stage = stage_colours, theiler = theiler_colours))

options(iSEE.maxlevels = 37)

iSEE(sce, appTitle = "NMP_EHF_C", colormap = ecm)
```

Deploy the iSEE application to the shiny server:

```{r}
deployApp(appDir = "shiny/annotated", appName = "NMP_EHF_C", appTitle = "NMP_EHF_C", launch.browser = FALSE, forceUpdate = TRUE)
```

Allocate more memory to the iSEE application:

```{r}
configureApp(appName = "NMP_EHF_C", appDir = "shiny/annotated", size = "xlarge")
```

### Integrated data

Delete existing iSEE directory for integrated data:

```{r}
unlink("shiny/integrated", recursive = TRUE)
```

Create iSEE directory for integrated data:

```{r}
dir.create("shiny/integrated", showWarnings = FALSE, mode = "0755")
```

Copy integrated data to iSEE directory:

```{r}
file.copy("output/10-atlas-integration.rds", "shiny/integrated/data.rds", overwrite = TRUE)
```

Write application code to file within iSEE directory:

```{cat, engine.opts = list(file = "shiny/integrated/app.R"), class.source = "r"}
library(SingleCellExperiment)

sce <- readRDS("data.rds")

rownames(sce) <- scuttle::uniquifyFeatureNames(rowData(sce)$gene_id, rowData(sce)$gene_name)

library(iSEE)

celltype_colours <- function(x) {
    return(
        c(
            "Epiblast" = "#635547",
            "Primitive Streak" = "#DABE99",
            "Caudal epiblast" = "#9e6762",
            "PGC" = "#FACB12",
            "Anterior Primitive Streak" = "#c19f70",
            "Notochord" = "#0F4A9C",
            "Def. endoderm" = "#F397C0",
            "Gut" = "#EF5A9D",
            "Nascent mesoderm" = "#C594BF",
            "Mixed mesoderm" = "#DFCDE4",
            "Intermediate mesoderm" = "#139992",
            "Caudal Mesoderm" = "#3F84AA",
            "Paraxial mesoderm" = "#8DB5CE",
            "Somitic mesoderm" = "#005579",
            "Pharyngeal mesoderm" = "#C9EBFB",
            "Cardiomyocytes" = "#B51D8D",
            "Allantois" = "#532C8A",
            "ExE mesoderm" = "#8870ad",
            "Mesenchyme" = "#cc7818",
            "Haematoendothelial progenitors" = "#FBBE92",
            "Endothelium" = "#ff891c",
            "Blood progenitors 1" = "#f9decf",
            "Blood progenitors 2" = "#c9a997",
            "Erythroid1" = "#C72228",
            "Erythroid2" = "#f79083",
            "Erythroid3" = "#EF4E22",
            "NMP" = "#8EC792",
            "Rostral neurectoderm" = "#65A83E",
            "Caudal neurectoderm" = "#354E23",
            "Neural crest" = "#C3C388",
            "Forebrain/Midbrain/Hindbrain" = "#647a4f",
            "Spinal cord" = "#CDE088",
            "Surface ectoderm" = "#f7f79e",
            "Visceral endoderm" = "#F6BFCB",
            "ExE endoderm" = "#7F6874",
            "ExE ectoderm" = "#989898",
            "Parietal endoderm" = "#1A1A1A"
        )
    )
)

stage_colours <- function(x) {
	return(
		c(
			"E6.5" = "#D53E4F",
			"E6.75" = "#F46D43",
			"E7.0" = "#FDAE61",
			"E7.25" = "#FEE08B",
			"E7.5" = "#FFFFBF",
			"E7.75" = "#E6F598",
			"E8.0" = "#ABDDA4",
			"E8.25" = "#66C2A5",
			"E8.5" = "#3288BD",
			"mixed_gastrulation" = "#A9A9A9"
		)
	)
}

theiler_colours <- function(x) {
	return(
		c(
			"TS9" = "#D7191C",
			"TS10" = "#FDAE61",
			"TS11" = "#ABDDA4",
			"TS12" = "#2B83BA",
			"TS9-10" = "#A9A9A9"
		)
	)
}

ecm <- ExperimentColorMap(colData = list(celltype = celltype_colours, stage = stage_colours, theiler = theiler_colours))

options(iSEE.maxlevels = 37)

iSEE(sce, appTitle = "NMP_EHF_C_ATLAS", colormap = ecm)
```

Deploy the iSEE application to the shiny server:

```{r}
deployApp(appDir = "shiny/integrated", appName = "NMP_EHF_C_ATLAS", appTitle = "NMP_EHF_C_ATLAS", launch.browser = FALSE, forceUpdate = TRUE)
```

Allocate more memory to the iSEE application:

```{r}
configureApp(appName = "NMP_EHF_C_ATLAS", appDir = "shiny/integrated", size = "xlarge")
```

## Summary

### Session

Print session information:

```{r}
sessionInfo()
```
